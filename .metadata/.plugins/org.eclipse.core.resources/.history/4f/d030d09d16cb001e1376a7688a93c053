package com.application.sevices;

import java.io.EOFException;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

import org.springframework.stereotype.Service;

import com.application.entities.Reservation;
import com.application.exception.DetailsNotFoundException;

@Service
public class ReservationService {

	private final String filePath = "Reservation.ser";

	// Saves the provided reservation object to the file and returns the saved
	// reservation object.
	public Reservation save(Reservation reservation) {

		try (ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(filePath, true))) {
			outputStream.writeObject(reservation);
		} catch (IOException e) {
			e.printStackTrace();
		}
		return reservation;
	}

	// Updates the reservation information with the specified ID and returns the
	// updated reservation object.
	public Reservation update(Integer id, Reservation reservation) {
		List<Reservation> reservation = get();
		for (int i = 0; i < reservation.size(); i++) {
			if (reservation.get(i).getId().equals(id)) {
				reservation.set(i, reservation);
				break;
			}
		}
		try (ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(filePath))) {
			for (Reservation reservation : reservations) {
				outputStream.writeObject(reservation);
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
		return updatedReservation;
	}

	// Retrieves a list of all reservations from the file.
	public List<Reservation> get() {
		List<Reservation> reservations = new ArrayList<>();
		try (ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(filePath))) {
			while (true) {
				try {
					Reservation reservation = (Reservation) inputStream.readObject();
					reservations.add(reservation);

				} catch (EOFException e) {
					break;
				}
			}
		} catch (IOException | ClassNotFoundException e) {
			e.printStackTrace();
		}
		return reservations;
	}

	// Retrieves the reservation with the specified ID from the file.
	public Reservation get(Integer id) {
		List<Reservation> reservations = get();
		System.out.println(reservations.size());
		for (Reservation reservation : reservations) {
			if (reservation.getId().equals(id)) {
				return reservation;
			}
		}
		throw new DetailsNotFoundException("Reservation is not found with ID : " + id);
	}

	// Deletes the reservation with the specified ID from the file and returns true
	// upon successful deletion.
	public Boolean delete(Integer id) {
		List<Reservation> reservations = get();
		boolean reservationExists = reservations.stream()
				.anyMatch(reservation -> Objects.equals(reservation.getId(), id));
		if (!reservationExists) {
			throw new DetailsNotFoundException("Reservation not found with ID: " + id);
		}
		reservations.removeIf(reservation -> reservation.getId().equals(id));
		saveReservations(reservations);
		return true;
	}

	// Helper method to save the list of reservations to the file.
	private void saveReservations(List<Reservation> reservations) {
		try (ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(filePath))) {
			for (Reservation reservation : reservations) {
				outputStream.writeObject(reservation);
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
}
